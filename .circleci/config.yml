version: 2
jobs:

  build_linux:
    machine: true
      
    working_directory: ~/mom_build
    
    steps:
      - checkout
            
      # Detour before building, let's set up the Steam Runtime
      - run:
          name: Installing required packages
          command: |
            sudo apt-get update
            sudo apt-get install -y --no-install-recommends build-essential gcc-multilib g++-multilib wget curl
      
      - run:
          name: Downloading the Steam Runtime
          command: |
            cd /
            sudo mkdir valve
            cd /valve
            sudo wget http://media.steampowered.com/client/runtime/steam-runtime-sdk_latest.tar.xz
            sudo tar xvf steam-runtime-sdk_latest.tar.xz
            sudo mv steam-runtime-sdk_2013-09-05 steam-runtime
            sudo chown root:root /valve/* -R
            
      - run:
          name: Setting up the Steam Runtime
          command: |
            cd /valve/steam-runtime
            sudo ./setup.sh --target="i386 amd64" --auto-update --release
            echo "Done setting up, now to set our architecture..."
            sudo ./shell.sh --arch=i386 &
            echo "Set our architecture!"
            
      - run:
          name: Doing a fix to the Steam Runtime...
          command: |
            cd /valve/steam-runtime/amd64/i686-unknown-linux-gnu/i686-unknown-linux-gnu/include/c++/4.6.3/
            sudo sed -i '1s/^/#undef min\n#undef max\n/' limits ./bits/random.h ./bits/algorithmfwd.h ./bits/stl_algobase.h
            
      # Ready, willing, and fully enabled
      - run:
          name: Creating game project files
          command: |
            cd mp/src
            sudo ./creategameprojects
      
      - run: 
          name: Building the game
          command: |
            cd ~/mom_build/mp/src
            sudo make -f games.mak

      - run:
          name: Zipping up artifacts
          command: |
            cd ~/mom_build
            zip -r binaries_linux.zip ~/mom_build/mp/game/bin ~/mom_build/mp/game/momentum/bin
            
      - store_artifacts:
          path: ~/mom_build/binaries_linux.zip
  
  build_mac:
    macos:
      xcode: "8.3.3"

    working_directory: ~/mom_build

    steps:
      - checkout

      - run:
          name: Create game project files
          command: |
            cd mp/src
            ./creategameprojects
       
      - run: 
          name: Building the game
          command: |
            cd ~/mom_build/mp/src
            xcodebuild -quiet -project games.xcodeproj -configuration Release -arch i386 -xcconfig devtools/release.xcconfig
            
      - run:
          name: Zipping up artifacts
          command: |
            cd ~/mom_build
            zip -r binaries_mac.zip ~/mom_build/mp/game/bin ~/mom_build/mp/game/momentum/bin
            
      - store_artifacts:
          path: ~/mom_build/binaries_mac.zip

workflows:
  version: 2
  build_game:
    jobs:
#      - build_mac
      - build_linux